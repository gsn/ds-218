<div id="flipp-container" ng-conroller='myController' ctrl-roundy-profile></div>
<script>
    // Initialize Hosted Circular
    var flippContainerId = 'flipp-container';
    var storeNumber = 8501;
    var gsnShoppingList = {};
    gsn.$store.getStore().then(function(rst) {
      storeNumber = rst.StoreNumber;
    });

    for (var k in window._tk.trackers) {
        window._tk.trackers[k].on('track', function(item) {
          console.log(item);
          if (item.ItemTypeId == 0) {

          }
        });
    }

    function doLoad() {
        // var storeNumber = localStorage.getItem("gsnStorage-storeNumber") || 8501
        console.log(storeNumber)
        wishabi.hostedservices.iframe.decorate(
            flippContainerId,
            'marianos',
            wishabi.hostedservices.iframe.Sizing.PAGE,
            {
                minHeight: 600,
                initialHeight: 600,
                extraPadding: 0,
                // auto_locate will auto locate the person based on IP
                // store_code is the store number passed through to us that needs to be passed to the iframe. 8501 is a example store we placed in the parameter as an example. 8539
                queryParameters: 'auto_locate=true&store_code='+storeNumber
            }
        );

        // Define Flipp API configuration parameters
        var flippDomain = 'http://www.circularhub.com';
        var flippIframe = document.getElementById(flippContainerId).getElementsByTagName('iframe')[0];

        // Define Shopping List event handlers
        var flippShoppingListDelegate = {
            handleItemAddedClicked: function(flippShoppingList, itemId, item) {
                window.console.log(item);
                window.console.log('Shopping List: Adding item ' + itemId);
                flippShoppingList.addItem(itemId);
               //To Add the item to the shopping list - item => Circular Hub response & itemid
                angular.element(document.getElementById('flipp-container')).scope().addFlyerItems(item, itemId);

            },
            handleItemRemovedClicked: function(flippShoppingList, itemId, item) {
                window.console.log('Shopping List: Removing item ' + itemId);
                window.console.log(item);
                flippShoppingList.removeItem(itemId);
               //To Add the item from the shopping list - item => Circular Hub response & itemid
                angular.element(document.getElementById('flipp-container')).scope().removeItemFromFlyer(item, itemId);
            },
            handleShoppingListOpen: function(flippShoppingList) {
                window.console.log('Shopping List: Open Shopping List');
            }
        };

        // Initialize Shopping List API and register event handlers
        var flippShoppingList = new wishabi.hostedservices.iframe.ShoppingList(
            window, flippIframe.contentWindow, flippShoppingListDelegate, flippDomain
        );

        // Define function to initialize user state in Flipp Iframe
        var initFlippUserState = function() {
            var shoppingList = {};
            var sl = gsn.$profile.getShoppingList();

           var items = [];
           var allItems = sl.allItems();
           angular.forEach(allItems, function(item, idx) {
              if (item.ItemTypeId === 0) {
                items.push(item.ItemId);
              }
           });
           flippShoppingList.setItems(items);
        };

        // Initialize user state once Flipp Iframe has loaded
        if (window.addEventListener) {
            flippIframe.addEventListener('load', initFlippUserState);
        } else if (window.attachEvent) {
            // Legacy Internet Explorer event listener
            flippIframe.attachEvent('onreadystatechange', function() {
                if ('complete' === flippIframe.readyState) {
                    initFlippUserState();
                }
            });
        }
    }

    gsn.loadScripts(['http://www.circularhub.com/hosted_services/js/1.7.0/wishabi.js'
        ,'http://www.circularhub.com/hosted_services/iframe.js'], doLoad);
</script>
